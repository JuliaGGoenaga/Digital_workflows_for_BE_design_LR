<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Literature Review ‚Äì KPI Matrix</title>
  <style>
    :root{
      /* Palette / layout */
      --panel:#ffffff; --border:#e2e8f0; --muted:#6b7280; --text:#0f172a; --accent:#0ea5e9; --accent2: #1f4d89;
      --radius:12px; --chip:#f8fafc;
      /* === EDITABLE style for the note below the matrix title === */
      --mx-note-fg:#475569;      /* text color */
      --mx-note-bg:#f8fafc;      /* background */
      --mx-note-bd:#e2e8f0;      /* border */
      --mx-note-r:10px;          /* radius */
      --mx-note-p:8px;           /* padding */
      --mx-note-fs:12px;         /* font size */
      --mx-note-fw:500;          /* font weight */
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif,system-ui; background:#f1f5f9; color:var(--text)}

    /* Title */
    .title-panel {text-align:left; margin:8px 16px 0 6px}
    .title-panel h1 {display:inline-flex; font-size:14px; font-weight:600; color:var(--accent2); padding:4px 10px; margin:0}
    .home-btn{display:inline-flex; align-items:center; justify-content:center; font-size:14px; border-radius:10px; margin:0; background:#f8fafc; text-decoration:none; border:1px solid #cbd5e1; color:#1f4d89; padding:4px 6px}
    .home-btn:hover{background:#f1f5f9}

    .muted {color: var(--muted); font-weight: 300; opacity: 0.95;font-size:12px}

    /* Layout */
    .app1{display:flex;  gap:10px; padding:10px}
    .app{display:grid; grid-template-columns: 1fr 380px; gap:10px; padding:10px}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:12px}
    h1{margin:0 0 8px 0; font-size:16px}
    .sub{ align-items: center; color:var(--muted); font-size:12px; margin-bottom:8px}
    .sub2{justify-content: space-between; align-items: center;  display: flex; color:var(--muted); font-size:12px; margin-bottom:2px}
    .sub_italic {color:var(--muted); font-size:13px; margin-top:8px; margin-bottom:8px; font-style:italic}

    /* Details */
    .details h2{font-size:14px; margin:12px 0 6px}
    .detail-kpi{color:var(--accent2); font-weight:500; font-size:14px; border:1px dashed var(--border); padding: 6px 6px ; border-radius: 10px ;margin-bottom: 10px;}
    .ref-list{display:flex; flex-wrap:wrap; gap:6px; max-height:28vh; overflow:auto; padding:6px; border-radius:10px}
    .ref-btn{font-size:12px; background:#fff; border:1px solid #94a3b8; border-radius:999px; padding:6px 8px; cursor:pointer}
    .ref-btn:hover{border-color:#bed0e9; box-shadow:0 0 0 3px rgba(103, 134, 172, 0.15)}
    .btn{display:inline-flex; gap:8px; margin-top:10px ; align-items:center; font-size:12px; padding:4px 6px; border-radius:10px; border:1px solid #cbd5e1; background:#f8fafc; color:var(--accent3); cursor:pointer; text-decoration:none;}

    /* Main sections */
    .main{display:grid; gap:12px}

    /* Section 1: 15x5 Matrix */
    .matrix{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:12px}
    .matrix h2{font-size:14px; margin:0 0 4px}
    .mx-note{color:var(--mx-note-fg); background:var(--mx-note-bg); border:1px dashed var(--mx-note-bd); border-radius:var(--mx-note-r); padding:var(--mx-note-p); font-size:var(--mx-note-fs); font-weight:var(--mx-note-fw); margin:6px 0 10px}

    .mx-grid{display:grid; grid-auto-rows:minmax(32px,auto); gap:6px}
    /* Each row is a 16-column grid: 1 for row labels + 15 for data columns */
    .mx-row{display:grid; grid-template-columns: repeat(16, minmax(64px, 1fr)); gap:6px; color:var(--accent2);}

    .mx-cell{border:1px solid var(--border); background:#f8fafc; border-radius:10px; padding:6px; display:flex; align-items:center; justify-content:center; font-size:12px; text-align:center}
    .mx-cell.clickable{cursor:pointer}

    /* Category header (row 1): checked/unchecked states */
    .cat-pill{border:1px solid currentColor; font-weight:700}
    .cat-pill.unchecked{background:#fff}
    .cat-pill.checked{background:currentColor; color:#fff}

    /* Class header (row 2) */
    .cls-pill{border:1px solid var(--border); font-weight:600; color:#334155}
    .cls-pill.unchecked{opacity:.35}
    .cls-pill.checked{border-color:currentColor}

    /* Bubbles 0/1/2 */
    .bubble{position:relative; width:26px; height:26px; border-radius:999px; border:1px dashed color-mix(in srgb, var(--muted) 50%, transparent); display:inline-flex; align-items:center; justify-content:center; opacity:1; transition:opacity .15s ease}
    .bubble .inner{width:12px; height:12px; border-radius:999px;}
    .b-0{color:#94a3b8}
    .b-0 .inner{background:transparent;}
    .b-1 .inner{width:14px; height:14px; background:currentColor; }
    .b-2 .inner{width:26px; height:26px; background:currentColor; }
    .dimmed{opacity:.22}

    /* Section 2: Class grid (dynamic based on filters) */
    .kpi-grid{background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:12px; }
    .kpi-grid h2{font-size:14px; margin:0 0 4px}
    .kg{display:grid; gap:8px; grid-template-columns: repeat(2, 1fr);}
    .kg-card{border:1px solid var(--border); background:#f8fafc; border-radius:12px; padding:8px; display: inline-flex; flex-direction:column; min-height:auto}
    .kg-title{font-weight:700; font-size:13px; margin-bottom:4px}
    .kg-sub{font-weight:600; font-size:12px; color:#334155; margin-bottom:8px}
    .kpi-list{display:flex; flex-wrap:wrap; gap:6px; overflow:auto}
    .kpi-chip{font-size:12px; background:var(--chip); border:1px solid var(--border); border-radius:10px; padding:6px 8px; cursor:pointer}
    .kpi-chip:hover{background:#fff}
    
    /* Bubble legend */
    .mx-legend { display:flex;  gap: 30px;  align-items: right;  vertical-align: center; margin: 10px 0 4px; }
    .legend-item {  display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--accent2); }
    .legend-label { font-size: 12px; color: var(--accent2) }

    /* MODAL: DOI */
    .modal-backdrop{display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:50}
    .modal{display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; color:#1e65a3; border:1px solid var(--border); border-radius:16px; width:80%; max-height: 80% ; z-index:60; box-shadow:0 20px 60px rgba(0,0,0,.5); overflow:auto}
    .modal-header{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border)}
    .modal-title { font-weight: 700;}
    .modal-body { padding: 16px; display: grid; gap: 8px; font-size: 12px; font-weight: 300;}
    .muted {color: #9c9a9a; margin-right: 4px;}
    .modal-body{padding:14px; display:grid; gap:8px; font-size:13px}
    .modal-sections{display:grid; gap:8px; grid-template-columns: 1fr 1fr 1fr 1fr; line-height:1.2; max-height:60vh; overflow:auto}

    /* Responsive */
    @media (max-width:1200px){ .kg{grid-template-columns: repeat(2, 1fr);} .mx-row{grid-template-columns: repeat(5, minmax(64px, 1fr));} }
    @media (max-width:900px){ .app{grid-template-columns:1fr;} }
  </style>
</head>
<body>


  <!-- Title -->
  <section class="title-panel">
    <a href="index.html" class="home-btn" title="Home">üè†</a>
    <h1>Digital workflows for informed decision making in building envelope design: A systematic literature review.</h1>
  </section>

  <!-- Section 1: 15x5 Matrix (embedded filters) -->
  <div class="app1">
    <section class="matrix">
      <h2>Performance objective categories and classes by design scale</h2>
      <div class="sub2">
        <div>Press any <strong>category and class</strong> labels to filter performance metrics.</div>
        <div class="mx-legend">
          <div class="legend-item">
            <span class="bubble b-0"><span class="inner"></span></span>
            <span class="legend-label">Non-relevant</span>
          </div>
          <div class="legend-item">
            <span class="bubble b-1"><span class="inner"></span></span>
            <span class="legend-label">Recommended</span>
          </div>
          <div class="legend-item">
            <span class="bubble b-2"><span class="inner"></span></span>
            <span class="legend-label">Relevant</span>
          </div>
        </div>
      </div>
      <div id="mx-grid" class="mx-grid"></div>
    </section>
  </div>

  <div class="app">
    <!-- Main content (left) -->
    <div class="main">
      <!-- Section 2: CLASS grid -->
      <section class="kpi-grid">
        <h2>Registered KPIs by class</h2>
        <div class="sub">Use <strong>filters</strong> above to see performance metrics by class.</div>
        <div id="kpi-grid" class="kg"></div>
      </section>
    </div>

    <!-- Details (right) -->
    <div class="panel details">
      <h1>Details</h1>
      <div class="sub">Press the <b>reference ID</b> to see more information and direct <b>DOI link</b>.</div>
      <section class="detail-kpi">
        <div id="detail-title"></div>
        <div class="muted" id="detail-count"></div>
      </section>
      <div id="ref-list" class="ref-list"></div>
      <a class="btn" id="see-all-refs" href="All_refs.html">See all references</a>
    </div>
  </div>

  <!-- Modal DOI -->
  <div id="modal-backdrop" class="modal-backdrop"></div>
  <div id="modal" class="modal">
    <div class="modal-header">
      <div class="modal-title">Reference data</div>
      <button id="modal-close" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <div><span class="muted">ID:</span> <span id="m-id"></span></div>
      <div><span class="muted">Title:</span> <span id="m-title"></span></div>
      <div><span class="muted">Year:</span> <span id="m-year"></span></div>
      <div><span class="muted">Authors:</span> <span id="m-authors"></span></div>
      <div><span class="muted">Link:</span> <a id="m-link" href="#" target="_blank" rel="noopener noreferrer">Open</a></div>
      <div id="m-empty" class="empty" style="display:none">No DOI available.</div>
      <hr class="modal-divider">
      <div id="m-sections" class="modal-sections"></div>
    </div>
  </div>

  <!-- Existing DB  -->
  <script src="data/data.js"></script>
  <script src="data/ref_modal.js"></script>
  <script src="data/KPI_data.js"></script>

  <script>
  // ========== Helpers & State ==========
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const stripAccents = (str) => str ? str.normalize('NFD').replace(/[\u0300-\u036f]/g,'') : '';
  const normKey = (str) => stripAccents(String(str||'').toLowerCase().trim().replace(/\s+/g,' '));

  const STATE = {
    categories: [],            // [{ name, color, start, span }]
    categoryColors: DATA.meta.performanceCategoryColors|| {},        // name -> color
    matriz: [],                // matriz_table (5 rows)
    cols: [],                  // columns (c>=1): {idx, cat, cls}

    // New filtering
    catChecked: {},            // catName -> boolean
    classChecked: {},          // columnIndex (>=1) -> boolean

    // KPI data
    kpiToRefs: {},
    kpisByCategoryAndClass: {},

    selected: { kind:null, key:null }
  };

  function hslForIndex(i){
    const N = Math.max(STATE.categories.length || 7, 7);
    const hue = Math.round((i * 360 / N) % 360);
    return `hsl(${hue}, 70%, 45%)`;
  }

  // ========== Load data ==========
  
  async function loadCustomData(){
    // Try multiple possible JSON locations
    const data = window.KPI_DATA;            // ‚Üê viene del script KPI_data.js
    if(!data){
      console.error('Could not load the matrix JSON.');
      STATE.matriz = [];
      STATE.kpiToRefs = {};
      STATE.kpisByCategoryAndClass = {};
      return;
    }
    STATE.matriz = data.matriz_table || [];
    STATE.kpiToRefs = data.kpi_ref_matches || {};
    STATE.kpisByCategoryAndClass = data.kpis_by_category_and_class || {};

    // Build columns from the matrix (c>=1)
    const rowCat = STATE.matriz[0] || [];
    const rowCls = STATE.matriz[1] || [];
    STATE.cols = [];
    for(let c=1; c<rowCat.length; c++){
      const cat = String(rowCat[c]||'').trim();
      const cls = String(rowCls[c]||'').trim();
      STATE.cols.push({ idx:c, cat, cls });
      STATE.classChecked[c] = false; // default UNCHECKED
    }

    // Group contiguous categories for header (span) and assign color
    const groups = [];
    let i=0;
    while(i<STATE.cols.length){
      const base = STATE.cols[i];
      let span=1; let j=i+1;
      while(j<STATE.cols.length && STATE.cols[j].cat === base.cat){ span++; j++; }
      groups.push({ name: base.cat, start: base.idx, span });
      i=j;
    }
    STATE.categories = groups.map((g, idx) => {
      const key = String(g.name || '').trim().toUpperCase();
      const fromData = STATE.categoryColors[key];       // viene de DATA.meta.performanceCategoryColors
      const color = fromData || hslForIndex(idx);       // fallback si no est√° en DATA
      return { ...g, color };
    });
    // guarda en el mapa usando la llave normalizada (MAY√öSCULAS)
    STATE.categories.forEach(c => {
      const key = String(c.name || '').trim().toUpperCase();
      STATE.categoryColors[key] = c.color;
    });

    // Category state (default UNCHECKED except ENERGY)
    STATE.categories.forEach(c => {
      if (c.name.toUpperCase() === 'ENERGY') {
        STATE.catChecked[c.name] = true;   // check category
        // also mark all its classes
        STATE.cols.forEach(col => {
          if (col.cat === c.name) {
            STATE.classChecked[col.idx] = true;
          }
        });
      } else {
        STATE.catChecked[c.name] = false;
      }
    });
  }

  // ========== Render: Matrix ==========
  function bubbleHTML(val, category){
    const key = String(category || '').trim().toUpperCase();
    const color = STATE.categoryColors[key] || '#94a3b8';
    const cls = (val==2? 'b-2' : val==1? 'b-1' : 'b-0');
    return `<span class="bubble ${cls}" style="color:${color}"><span class="inner"></span></span>`;
  }

  function renderMatrix(){
    const root = $('#mx-grid'); root.innerHTML = '';
    const M = STATE.matriz; if(!M.length) return;
    const rows = M.length; const cols = (M[0]||[]).length; // 5,16

    // === Row 1: CATEGORIES (span conditional to # of classes) ===
    const r1 = document.createElement('div'); r1.className = 'mx-row';
    // Cell 0 (label)
    const c0 = document.createElement('div'); c0.className = 'mx-cell'; c0.textContent = 'Categories'; r1.appendChild(c0);

    // Add category pills with spans
    STATE.categories.forEach(cat => {
      const pill = document.createElement('div');
      pill.className = 'mx-cell cat-pill clickable';
      pill.style.gridColumn = `${cat.start+1} / span ${cat.span}`; // +1 for the label column
      
      const isOn = STATE.catChecked[cat.name];
      const key = String(cat.name || '').trim().toUpperCase();
      const catColor = STATE.categoryColors[key];
      if (isOn) {pill.style.color = '#fff' ; pill.style.backgroundColor = catColor }
      else {pill.style.color = catColor }

      pill.classList.toggle('checked', !!isOn);
      pill.classList.toggle('unchecked', !isOn);
      pill.textContent = cat.name;
      pill.title = (isOn? 'Uncheck category' : 'Check category');
      pill.addEventListener('click', () => toggleCategory(cat.name));
      r1.appendChild(pill);
    });
    root.appendChild(r1);

    // === Row 2: CLASSES ===
    const r2 = document.createElement('div'); r2.className = 'mx-row';
    for(let c=0; c<cols; c++){
      let cell = document.createElement('div'); cell.className = 'mx-cell';
      if(c===0){ cell.textContent = 'Classes'; }
      else{
        const v = (M[1]||[])[c];
        const col = STATE.cols.find(x => x.idx===c);
        const pill = document.createElement('div');
        const key = col ? String(col.cat || '').trim().toUpperCase() : '';
        pill.className = 'mx-cell cls-pill clickable';
        pill.style.color = (col && STATE.categoryColors[key]) || '#334155';
        const isOn = !!STATE.classChecked[c];
        pill.classList.toggle('checked', isOn);
        pill.classList.toggle('unchecked', !isOn);
        pill.textContent = String(v||'');
        pill.title = (isOn? 'Uncheck class' : 'Check class');
        pill.addEventListener('click', () => toggleClass(c));
        cell = pill;
      }
      r2.appendChild(cell);
    }
    root.appendChild(r2);

    // === Rows 3..5: values ===
    for(let r=2; r<rows; r++){
      const rowEl = document.createElement('div'); rowEl.className = 'mx-row';
      for(let c=0; c<cols; c++){
        const v = (M[r]||[])[c];
        const cell = document.createElement('div'); cell.className = 'mx-cell';
        if(c===0){ cell.textContent = String(v||''); }
        else{
          const cat = String(M[0][c]||'');
          const val = (v===undefined || v===''? '' : Number(v));
          cell.innerHTML = (val===0 || val===1 || val===2) ? bubbleHTML(val, cat) : '';
          // Dim based on effective column state (cat && class)
          const effective = isColumnActive(c);
          if(!effective && cell.firstChild){ cell.firstChild.classList.add('dimmed'); }
        }
        rowEl.appendChild(cell);
      }
      root.appendChild(rowEl);
    }
  }

  function isColumnActive(c){
    const col = STATE.cols.find(x => x.idx===c); if(!col) return false;
    return !!(STATE.catChecked[col.cat] && STATE.classChecked[c]);
  }

  // ========== Render: Class grid by category ==========
  function renderKpiGrid(){
    const root = $('#kpi-grid'); root.innerHTML = '';
    // active columns => cards
    const actives = STATE.cols.filter(col => isColumnActive(col.idx));
    if(!actives.length){
      const empty = document.createElement('div');
      empty.className = 'sub_italic';
      empty.textContent = '‚Äî No active classes ‚Äî';
      root.appendChild(empty);
      return;
    }

    actives.forEach(item => {
      const card = document.createElement('div'); card.className = 'kg-card';

      const titleCat = document.createElement('div'); titleCat.className = 'kg-title';
      const kpis = getKpisForCategoryClass(item.cat, item.cls);
      const key = String(item.cat || '').trim().toUpperCase();
      titleCat.textContent = item.cat || '‚Äî';
      titleCat.style.color = STATE.categoryColors[key] || '#0f172a';
      card.appendChild(titleCat);

      const titleCls = document.createElement('div'); titleCls.className = 'kg-sub clickable';
      titleCls.textContent = item.cls || '';
      titleCls.addEventListener('click', ()=> showDetailsForClass(item.cat, item.cls));
      card.appendChild(titleCls);

      const list = document.createElement('div'); list.className = 'kpi-list';
      
      kpis.forEach(kpi => {
        const chip = document.createElement('button');
        chip.className = 'kpi-chip';
        chip.textContent = kpi;
        chip.style.borderColor = STATE.categoryColors[key] || '#e5e7eb';
        chip.addEventListener('click', () => showDetailsForKpi(kpi));
        list.appendChild(chip);
      });
      card.appendChild(list);

      root.appendChild(card);
    });
  }

  function getKpisForCategoryClass(cat, cls){
    if(String(cat).toLowerCase() === 'categories') return [];
    if(String(cls).toLowerCase() === 'classes') return [];
    return ((STATE.kpisByCategoryAndClass||{})[cat]||{})[cls] || [];
  }

  // ========== Interaction (toggle) ==========
  function toggleCategory(catName){
    const willCheck = !STATE.catChecked[catName];
    STATE.catChecked[catName] = willCheck;

    // When (un)checking a category, (un)check ALL its classes automatically
    STATE.cols.forEach(col => {
      if(col.cat === catName){
        STATE.classChecked[col.idx] = willCheck ? true : false;
      }
    });

    // Category remains checked if at least one class is checked
    const anyOn = STATE.cols.some(col => col.cat===catName && STATE.classChecked[col.idx]);
    STATE.catChecked[catName] = anyOn;

    renderMatrix();
    renderKpiGrid();
  }

  function toggleClass(colIdx){
    STATE.classChecked[colIdx] = !STATE.classChecked[colIdx];
    // Sync category state: checked if any class of that category is checked
    const col = STATE.cols.find(x => x.idx===colIdx); if(col){
      const anyOn = STATE.cols.some(c => c.cat===col.cat && STATE.classChecked[c.idx]);
      STATE.catChecked[col.cat] = anyOn; // none -> false; any -> true
    }
    renderMatrix();
    renderKpiGrid();
  }

  // ========== Details & Modal ==========
  function setDetails(title, refIds){
    $('#detail-title').textContent = title || '‚Äî';
    $('#detail-count').textContent = `${(refIds||[]).length} reference(s)`;
    const list = $('#ref-list'); list.innerHTML = '';
    (refIds||[]).forEach(id => {
      const btn = document.createElement('button'); btn.className = 'ref-btn'; btn.textContent = id;
      btn.addEventListener('click', () => openRefModalCombined(String(id)));
      list.appendChild(btn);
    });
  }

  function showDetailsForKpi(kpi){
    const refs = ((STATE.kpiToRefs||{})[kpi] || []);
    setDetails(kpi, refs);
  }

  function showDetailsForClass(cat, cls){
    const kpis = getKpisForCategoryClass(cat, cls);
    const refs = Array.from(new Set(kpis.flatMap(k => (((STATE.kpiToRefs||{})[k]) || []))));
    setDetails(`${cat} ‚Ä¢ ${cls}`, refs);
  }

  // Modal using DATA.* from data/ref_modal.js
  function openRefModalCombined(refId){
      const info = DATA.DOI[refId] || {};
      const backdrop = document.getElementById("modal-backdrop");
      const modal    = document.getElementById("modal");
      const mId      = document.getElementById("m-id");
      const mTitle   = document.getElementById("m-title");
      const mYear    = document.getElementById("m-year");
      const mAuthors = document.getElementById("m-authors");
      const mLink    = document.getElementById("m-link");
      const mEmpty   = document.getElementById("m-empty");
      const mSections= document.getElementById("m-sections");

      mId.textContent = refId;
      mTitle.textContent = info.Title||"";
      mYear.textContent = info.Year||"";
      mAuthors.textContent = info.Authors||"";
      if(info.Link){ mLink.href=info.Link; mLink.style.pointerEvents="auto"; mLink.style.opacity="1"; if(mEmpty) mEmpty.style.display="none"; }
      else { mLink.href="#"; mLink.style.pointerEvents="none"; mLink.style.opacity="0.6"; if(mEmpty) mEmpty.style.display="block"; }

      mSections.innerHTML = "";
      const srcVars = DATA.REF_MODAL["VARIABLES"][refId] || [];
      const srcPerf = DATA.REF_MODAL["PERFORMANCE OBJECTIVES"][refId] || [];
      const srcAcc  = DATA.REF_MODAL["ACCELERATORS"][refId] || [];

      const taskNums = new Set();
      srcVars.forEach(t => taskNums.add(t.n));
      srcPerf.forEach(t => taskNums.add(t.n));
      srcAcc.forEach(t => taskNums.add(t.n));
      const ordered = [...taskNums].filter(n=>n>=1 && n<=4).sort((a,b)=>a-b);

      if(!ordered.length){
        const none=document.createElement("div");
        none.className="empty";
        none.textContent="No extra data for this reference.";
        mSections.appendChild(none);
      } else {
        ordered.forEach(n => {
          const wrap=document.createElement("div");
          wrap.style.border="1px solid #e2e8f0";
          wrap.style.borderRadius="12px";
          wrap.style.padding="10px";

          const h=document.createElement("div");
          h.textContent="Task "+n;
          h.style.fontWeight="700";
          h.style.marginBottom="6px";
          wrap.appendChild(h);

          // META
          const metas=[];
          [srcVars, srcPerf, srcAcc].forEach(arr => {
            const t = arr.find(x => x.n===n);
            if(t && Array.isArray(t.sections)){
              t.sections.forEach(sec => {
                const title = String(sec.title||"");
                if(title.startsWith("Design scale:") || title.startsWith("Design stage:") || title.startsWith("Type of problem:") || title.startsWith("Type of change:")){
                  if(!metas.some(m => m.title===title)) metas.push({title, text:sec.text||""});
                }
              });
            }
          });
          metas.forEach(sec => {
            const line=document.createElement("div");
            const title=String(sec.title);
            const idx=title.indexOf(":");
            const label = idx>=0? title.slice(0,idx) : title;
            const value = idx>=0? title.slice(idx+1).trim() : (sec.text||"");
            if(!value) return;
            line.innerHTML = "<strong>"+label+":</strong> "+value;
            wrap.appendChild(line);
          });
          if(metas.length){
            const divider = document.createElement("hr");
            divider.style.margin="8px 0";
            divider.style.border="none";
            divider.style.borderTop="1px solid #e2e8f0";
            wrap.appendChild(divider);
          }

          // Helper para t√≠tulo + contenido + separador
          function addFamily(titleText, contentFn, isLast=false){
            const fam = document.createElement("div");
            fam.style.fontWeight="200";
            fam.style.margin = "4px 0 6px 0";
            fam.textContent = titleText;
            fam.style.textTransform = "uppercase";
            fam.style.fontSize =  "12px";
            fam.style.textAlign = "right";
            wrap.appendChild(fam);

            contentFn();

            if(!isLast){
              const sep = document.createElement("hr");
              sep.style.margin="8px 0";
              sep.style.border="none";
              sep.style.borderTop="1px solid #e2e8f0";
              wrap.appendChild(sep);
            }
          }

          // VARIABLES
          addFamily("Variables", () => {
            const tv = srcVars.find(x => x.n===n);
            if (tv){
              if (tv.title && tv.text){
                const st=document.createElement("div"); st.style.fontWeight="600"; st.textContent=tv.title;
                const p=document.createElement("div"); p.style.whiteSpace="pre-wrap"; p.style.margin="6px 0 10px 0"; p.textContent=tv.text;
                wrap.appendChild(st); wrap.appendChild(p);
              }
              if (Array.isArray(tv.sections)){
                tv.sections.forEach(sec => {
                  if(!sec.text || String(sec.text).trim()==="") return;
                  const st=document.createElement("div"); st.style.fontWeight="600"; st.textContent=sec.title;
                  const p=document.createElement("div"); p.style.whiteSpace="pre-wrap"; p.style.margin="6px 0 10px 0"; p.textContent=sec.text;
                  wrap.appendChild(st); wrap.appendChild(p);
                });
              }
            }
          });

          // PERFORMANCE OBJECTIVES
          addFamily("Performance objectives", () => {
            const tp = srcPerf.find(x => x.n===n);
            if (tp && Array.isArray(tp.sections)){
              tp.sections.forEach(sec => {
                if(!sec.text || String(sec.text).trim()==="") return;
                const st=document.createElement("div"); st.style.fontWeight="600"; st.textContent=sec.title;
                const p=document.createElement("div"); p.style.whiteSpace="pre-wrap"; p.style.margin="6px 0 10px 0"; p.textContent=sec.text;
                wrap.appendChild(st); wrap.appendChild(p);
              });
            }
          });

          // ACCELERATORS (√∫ltima familia -> sin separador extra)
          addFamily("Accelerators", () => {
            const ta = srcAcc.find(x => x.n===n);
            if (ta && Array.isArray(ta.sections)){
              ta.sections.forEach(sec => {
                if(!sec.text || String(sec.text).trim()==="") return;
                const st=document.createElement("div"); st.style.fontWeight="600"; st.textContent=sec.title;
                const p=document.createElement("div"); p.style.whiteSpace="pre-wrap"; p.style.margin="6px 0 10px 0"; p.textContent=sec.text;
                wrap.appendChild(st); wrap.appendChild(p);
              });
            }
          }, true);

          mSections.appendChild(wrap);
        });
      }

      backdrop.style.display="block"; modal.style.display="block";
      document.getElementById("modal-backdrop").onclick = () => { backdrop.style.display="none"; modal.style.display="none"; };
      document.getElementById("modal-close").onclick = () => { backdrop.style.display="none"; modal.style.display="none"; };
    }
    
  window.openRefModalCombined = openRefModalCombined;

  // ========== Boot ==========
  (async function(){
    await loadCustomData();
    renderMatrix();
    renderKpiGrid();
  })();
  </script>
</body>
</html>
